<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Javascript on Xing Yahao</title>
    <link>https://xingyahao.com/tags/javascript/</link>
    <description>Recent content in Javascript on Xing Yahao</description>
    <generator>Hugo</generator>
    <language>en-us</language>
    <copyright>© Xing Yahao</copyright>
    <lastBuildDate>Mon, 16 Jan 2023 09:25:36 +0900</lastBuildDate>
    <atom:link href="https://xingyahao.com/tags/javascript/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Javascript Monorepo Development Improvement Approaches</title>
      <link>https://xingyahao.com/posts/javascript-monorepo-development-improvement-approaches/</link>
      <pubDate>Mon, 16 Jan 2023 09:25:36 +0900</pubDate>
      <guid>https://xingyahao.com/posts/javascript-monorepo-development-improvement-approaches/</guid>
      <description>&lt;p&gt;Monorepo (monorepo) refers to a pattern where all code of an application or microservice is stored in a single monolithic repository (usually Git).&lt;/p&gt;&#xA;&lt;p&gt;Until now, both backend and frontend have been managed in the same repository, the so-called JavaScript monorepo. The &lt;a href=&#34;https://classic.yarnpkg.com/en/docs/yarn-workflow&#34;&gt;yarn workspace&lt;/a&gt; function is mainly used to share the backend/frontend and logic code, and also to avoid the need to switch between the two repositories. No more need to send out code reviews to multiple repositories. We were able to develop quickly because we only needed to clone and modify one repository.&lt;/p&gt;</description>
    </item>
    <item>
      <title>JavaScript Monorepo 開発改善への取り組みについて(Japanese)</title>
      <link>https://xingyahao.com/posts/javascript-monorepo-development-improvement-approaches-ja/</link>
      <pubDate>Fri, 16 Dec 2022 09:25:36 +0900</pubDate>
      <guid>https://xingyahao.com/posts/javascript-monorepo-development-improvement-approaches-ja/</guid>
      <description>&lt;p&gt;Monorepo(モノレポ)とは、アプリケーションやマイクロサービスの全コードを単一のモノリシックなリポジトリ (普通は Git) に保存するパターンを指します。&lt;/p&gt;&#xA;&lt;p&gt;今まで backend/frontend ともに JavaScript で同じリポジトリで管理されて、いわゆる JavaScript の モノレポです。主に &lt;a href=&#34;https://classic.yarnpkg.com/en/docs/yarn-workflow&#34;&gt;yarn workspace&lt;/a&gt; 機能を使って、backend/frontend とロジックのコードをシェアーして、また、それぞれのレポジトリの切り替えが必要なく、コードレビューを複数に出す必要もなくなりました。一つのリポジトリさえクローンして修正すればいいので、素早く開発できました。&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://storage.googleapis.com/zenn-user-upload/0b6954535479-20240604.png&#34; alt=&#34;Multi-Repo vs Monorepo&#34; loading=&#34;lazy&#34; decoding=&#34;async&#34;&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;しかし、一年前状況を振り返ったら、二つ大きな問題点があります。&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://classic.yarnpkg.com/lang/en/&#34;&gt;yarn 1&lt;/a&gt; (以降 yarn と呼びます)の機能不足(詳細は&lt;a href=&#34;https://xingyahao.com/posts/npm-yarn-pnpm-ja/&#34;&gt;去年の記事&lt;/a&gt;)で新規プロジェクトを同じリポジトリに workspace の package として作れないこと。&lt;/li&gt;&#xA;&lt;li&gt;環境のローカルサーバが立ち上がるのが 120 秒以上かかるなど開発者体験が悪いことです。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;チーム内に一度今後の構成について、モノレポかマルチレポか議論が上がりましたが、その時はプロジェクトのスケジュールを優先してマルチレポを選びました。しかし共通コンポーネントが共有しづらいとか、複数のレポジトリにまたがる開発のコードレビューが難しいとか、開発の効率がモノレポより下がっていることがわかっていました。&lt;/p&gt;&#xA;&lt;p&gt;これら改善のタスクは私のチームに任させて、今年に色々施策して、改善してきました。&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;新規の package を元のモノレポ配下に作ることができて、既存のロジックなどを簡易に再利用できました。&lt;/li&gt;&#xA;&lt;li&gt;ローカルサーバの立ち上がる時間は元の50%まで激減して、開発者体験向上や開発スピードが上がりました。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;様々な取り組み&#34;&gt;様々な取り組み&lt;/h2&gt;&#xA;&lt;h2 id=&#34;shared-リポジトリの作成&#34;&gt;shared リポジトリの作成&lt;/h2&gt;&#xA;&lt;p&gt;当時モノレポかマルチレポかまだ決まっていない段階で、取り敢えずコードシェアーが目の前の問題なので、&lt;a href=&#34;https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry&#34;&gt;Github private npm registery&lt;/a&gt; を利用して、複数箇所にコピペされていたコードをnpm packageにして、共有できました。&lt;a href=&#34;https://lerna.js.org/&#34;&gt;Lerna&lt;/a&gt; を使って、backend/frontend/共通 それぞれの package を作って複数のリポジトリに必要なロジックを該当の package 移して、更新したら、CIで新バージョンを publish と作りました。&lt;/p&gt;&#xA;&lt;p&gt;しかし、実際に運用してみたら、以下の問題点があります。&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;shared リポジトリのコードを更新したら、新しいバージョンの更新のCIを待つ必要がある&lt;/li&gt;&#xA;&lt;li&gt;プロジェクトのリポジトリのバージョンは頻繁に更新&lt;/li&gt;&#xA;&lt;li&gt;新しいエンジニアに shared リポジトリの使い方の教育&lt;/li&gt;&#xA;&lt;li&gt;ロジックが分散し、デバッグが難しい&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;これらが shared リポジトリの特徴なので、解決しづらいと認識して、今後もモノレポの方針を固めました。&lt;/p&gt;&#xA;&lt;h2 id=&#34;yarn-berry-に移行&#34;&gt;yarn berry に移行&lt;/h2&gt;&#xA;&lt;p&gt;yarn の &lt;a href=&#34;https://classic.yarnpkg.com/blog/2018/02/15/nohoist/&#34;&gt;hoist&lt;/a&gt; が workspace メインの問題点なので、hoist を解決するため、色々試してみました。まず、yarn の nohoist を利用しましたが、結果根本的に解決できません。&lt;/p&gt;</description>
    </item>
    <item>
      <title>Shortcomings of npm/yarn and reasons for recommending pnpm</title>
      <link>https://xingyahao.com/posts/npm-yarn-pnpm/</link>
      <pubDate>Mon, 10 Jan 2022 11:52:46 +0900</pubDate>
      <guid>https://xingyahao.com/posts/npm-yarn-pnpm/</guid>
      <description>&lt;h2 id=&#34;what-is-pnpm&#34;&gt;What is pnpm?&lt;/h2&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://pnpm.io/&#34;&gt;pnpm&lt;/a&gt; According to the official website, pnpm stands for performant npm.&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Fast, disk space efficient package manager&lt;/p&gt;&lt;/blockquote&gt;&#xA;&lt;p&gt;So, pnpm is similar to npm/yarn. Currently (December 2021), many major open source projects (&lt;a href=&#34;https://github.com/vuejs/vue-next&#34;&gt;vue&lt;/a&gt;, &lt;a href=&#34;https://github.com/prisma/prisma&#34;&gt;prisma&lt;/a&gt;&amp;hellip;) use pnpm. This article will look at the shortcomings of npm/yarn and how pnpm solved them in detail.&lt;/p&gt;&#xA;&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;&#xA;&lt;p&gt;npm/yarn - Shortcomings&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;The flat node_modules structure allows access to any package that is not referenced.&lt;/li&gt;&#xA;&lt;li&gt;Packages from different projects cannot be shared, resulting in disk space consumption.&lt;/li&gt;&#xA;&lt;li&gt;Installation speed is slow, and there are duplicate installations in node_modules.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;pnpm - Solution&lt;/p&gt;</description>
    </item>
    <item>
      <title>npm/yarn の不足点と pnpm を推す理由(Japanese)</title>
      <link>https://xingyahao.com/posts/npm-yarn-pnpm-ja/</link>
      <pubDate>Mon, 06 Dec 2021 11:46:46 +0900</pubDate>
      <guid>https://xingyahao.com/posts/npm-yarn-pnpm-ja/</guid>
      <description>&lt;h2 id=&#34;pnpmとは&#34;&gt;pnpmとは&lt;/h2&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://pnpm.io/&#34;&gt;pnpm&lt;/a&gt; 公式サイトによると、pnpmはperformant npmを表しています。&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Fast, disk space efficient package manager&lt;/p&gt;&lt;/blockquote&gt;&#xA;&lt;p&gt;なので、pnpmはnpm/yarn同じような存在です。現在（2021年12月）、たくさんメジャーのオープンソースプロジェクト（&lt;a href=&#34;https://github.com/vuejs/vue-next&#34;&gt;vue&lt;/a&gt;、&lt;a href=&#34;https://github.com/prisma/prisma&#34;&gt;prisma&lt;/a&gt;&amp;hellip;）は pnpmを使用しています。本文はnpm/yarnの不足点、とpnpmはどっやって解決したのかついにて詳細を見てみます。&lt;/p&gt;&#xA;&lt;h2 id=&#34;結論&#34;&gt;結論&lt;/h2&gt;&#xA;&lt;p&gt;npm/yarn - 不足点&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;フラットのnode_modules構造は、引用していない任意のパッケージにもアクセスできてしまう。&lt;/li&gt;&#xA;&lt;li&gt;違うプロジェクトのパッケージが共有できなくて、ディスク容量消耗になる。&lt;/li&gt;&#xA;&lt;li&gt;インストールのスピードが遅い、node_modulesに重複のインストールがある。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;pnpm - 解決法&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;シンボリックリンクを用い独自のnode_modules構造を使用して、package.jsonにあるものしかアクセスできない（厳格）。&lt;/li&gt;&#xA;&lt;li&gt;インストールするパッケージはグローバルストアからハードリンクされ、ディスク容量をセーブ（効率的）。&lt;/li&gt;&#xA;&lt;li&gt;上記の対応で、インストールも早くなる（速い）。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;厳格、効率的、速いとモノリポサポートも公式サイトから、pnpmの特徴と言われています。ただ、npm8とyarnもモノリポサポートなので、一応不足点だと考えていないです。pnpmのモノリポをサポートは最後で少し話します。&lt;/p&gt;&#xA;&lt;h2 id=&#34;ディスクスペース&#34;&gt;ディスクスペース&lt;/h2&gt;&#xA;&lt;h3 id=&#34;npmyarn---ディスクスペース消耗のnode_modules&#34;&gt;npm/yarn - ディスクスペース消耗のnode_modules&lt;/h3&gt;&#xA;&lt;p&gt;npm/yarnはディスク容量使いすぎという不足点があって、同じパッケージを100回分インストールしたら、100分のパッケージがnode_modulesのディスクに保存されます。日常の例では、前のプロジェクトが終わって、node_modulesがそのまま残ってしまったら、大量のディスク容量を使うことがよくあります。これを解決するため、&lt;a href=&#34;https://npkill.js.org/&#34;&gt;npkill&lt;/a&gt;がよく使われます。&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$ npx npkill&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;で現在フォルダ配下で全てのnode_modulesをスキャンして、動的で削除できます。&lt;/p&gt;&#xA;&lt;h3 id=&#34;pnpm---効率的なディスクスペース&#34;&gt;pnpm - 効率的なディスクスペース&lt;/h3&gt;&#xA;&lt;p&gt;一方、pnpmはパッケージを同一フォルダ（content-addressable store）に保存して、同じパッケージの同じばジョンを再度インストールしたら、ハードリンクを作るだけです。MacOsデフォルトの場所は~/.pnpm-storeになります。しかも、同じパッケージの違うバージョンは差分だけが新たに保存されます。そうしたら、インストールする時に、storeにあったら、再利用、なければ、ダンロードしてstoreに保存する形になります。&lt;/p&gt;&#xA;&lt;p&gt;ハードリンクを使って、できたことは&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;インストールが非常に高速(&lt;a href=&#34;https://pnpm.io/benchmarks&#34;&gt;ベンチマーク&lt;/a&gt;でyarnの&lt;a href=&#34;https://classic.yarnpkg.com/en/docs/pnp/&#34;&gt;pnpモード&lt;/a&gt;より早い)&lt;/li&gt;&#xA;&lt;li&gt;ディスク容量節約&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;以下はexpressをインストールしたことがあるパソコンで再インストールする時のアウトプットです。ついでに、npm/yarnインストール時のアウトプットも貼っておきます。&lt;/p&gt;&#xA;&lt;p&gt;pnpm&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-gdscript3&#34; data-lang=&#34;gdscript3&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#fe8019&#34;&gt;$&lt;/span&gt; pnpm i express&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Packages: &lt;span style=&#34;color:#fe8019&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#d3869b&#34;&gt;52&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#fe8019&#34;&gt;++++++++++++++++++++++++++++++++++++++++++++++++++++&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Progress: resolved &lt;span style=&#34;color:#d3869b&#34;&gt;52&lt;/span&gt;, reused &lt;span style=&#34;color:#d3869b&#34;&gt;52&lt;/span&gt;, downloaded &lt;span style=&#34;color:#d3869b&#34;&gt;0&lt;/span&gt;, added &lt;span style=&#34;color:#d3869b&#34;&gt;0&lt;/span&gt;, done&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;dependencies:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#fe8019&#34;&gt;+&lt;/span&gt; express &lt;span style=&#34;color:#d3869b&#34;&gt;4.17&lt;/span&gt;&lt;span style=&#34;color:#fe8019&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#d3869b&#34;&gt;1&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;npm&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$ npm i express&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;npm WARN npm@1.0.0 No description&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;npm WARN npm@1.0.0 No repository field.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+ express@4.17.1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;added 50 packages from 37 contributors and audited 50 packages in 4.309s&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;found 0 vulnerabilities&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;yarn&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
